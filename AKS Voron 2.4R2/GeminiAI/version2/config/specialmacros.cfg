[gcode_macro TEST_SPEED]
description: Test motion system at high speeds/accels. Usage: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=5
gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Bounding box (in case of min/max/endstop differences)
    {% set bound = params.BOUND|default(20)|int %}
    
    # Coordinates
    {% set x_min = printer.toolhead.axis_minimum.x + bound %}
    {% set x_max = printer.toolhead.axis_maximum.x - bound %}
    {% set y_min = printer.toolhead.axis_minimum.y + bound %}
    {% set y_max = printer.toolhead.axis_maximum.y - bound %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Absolute positioning
    G90
    
    # Set new limits
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}

    # Home if not homed
    {% if not 'xyz' in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    # Go to starting position (Center)
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed * 60}

    {% for i in range(iterations) %}
        # Large Box Pattern
        G0 X{x_min} Y{y_min} F{speed * 60}
        G0 X{x_max} Y{y_max} F{speed * 60}
        G0 X{x_min} Y{y_min} F{speed * 60}
        G0 X{x_max} Y{y_min} F{speed * 60}
        G0 X{x_min} Y{y_max} F{speed * 60}
        G0 X{x_max} Y{y_min} F{speed * 60}
        
        # Diagonals
        G0 X{x_min} Y{y_min} F{speed * 60}
        G0 X{x_max} Y{y_max} F{speed * 60}
        G0 X{x_max} Y{y_min} F{speed * 60}
        G0 X{x_min} Y{y_max} F{speed * 60}
    {% endfor %}

    # Restore limits and state
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    RESTORE_GCODE_STATE NAME=TEST_SPEED




#Comment Line Below

#     How to use it safely:
# Restart Klipper after adding the code.

# Home your printer (G28).

# Be ready with your finger on the Emergency Stop button.

# Enter the command in the console. Start conservative:

# TEST_SPEED SPEED=300 ACCEL=3000 ITERATIONS=5
# If that sounds clean (no grinding noises), try pushing the limits:

# TEST_SPEED SPEED=400 ACCEL=5000 ITERATIONS=10
# Note: This macro respects the max_velocity in your printer.cfg unless you specifically override it inside the macro call. If your printer limits are set to 300, and you type SPEED=500, Klipper might cap it at 300 unless you increase the max_velocity in config/steppers.cfg.

# Final Review of your Config Setup
# You now have a fully modular Klipper setup:

# printer.cfg: The skeleton that loads everything.

# user_settings.cfg: The ONLY file you need to open to change Z-offset, Temperatures, IDs, or Motor Currents.

# config/ folder: Holds the heavy lifting (steppers.cfg, toolhead.cfg, eddy.cfg, macros.cfg).

# Macros: You have PRINT_START, PRINT_END, CANCEL_PRINT, Filament loads (M600), Parking, Homing (CG28), and now the benchmarking tool TEST_SPEED.

# Is there any specific part of the wiring (like the Eddy USB or CANbus) you want me to double-check before you power on?